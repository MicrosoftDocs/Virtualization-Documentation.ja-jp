---
title: 仮想プロセッサ
description: ハイパーバイザー仮想プロセッサインターフェイス
keywords: hyper-v
author: alexgrest
ms.author: alegre
ms.date: 10/15/2020
ms.topic: reference
ms.prod: windows-10-hyperv
ms.openlocfilehash: a27d41b5d459e75af0fcbaf80de02b8e07d66391
ms.sourcegitcommit: d43632e3dc22e2b7a256b5c15fbb665c047de286
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/16/2020
ms.locfileid: "92120891"
---
# <a name="virtual-processors"></a>仮想プロセッサ

各パーティションには、0個以上の仮想プロセッサを含めることができます。

## <a name="virtual-processor-indices"></a>仮想プロセッサのインデックス

仮想プロセッサは、パーティション ID とそのプロセッサインデックスで構成される組によって識別されます。 プロセッサインデックスは、作成時に仮想プロセッサに割り当てられ、仮想プロセッサの有効期間を通じて変更されません。

特定の状況で "任意の仮想プロセッサ" を指定するために HV_ANY_VP 特別な値を使用できます。 HV_VP_INDEX_SELF の値を使用して、独自の VP インデックスを指定できます。

```c
typedef UINT32 HV_VP_INDEX;

#define HV_ANY_VP ((HV_VP_INDEX)-1)

#define HV_VP_INDEX_SELF ((HV_VP_INDEX)-2)
 ```

仮想プロセッサの ID は、ハイパーバイザーで定義された MSR (モデル固有のレジスタ) HV_X64_MSR_VP_INDEX を通じてゲストが取得できます。

```c
#define HV_X64_MSR_VP_INDEX 0x40000002
 ```

## <a name="virtual-processor-idle-sleep-state"></a>仮想プロセッサのアイドル状態のスリープ状態

仮想プロセッサは、仮想アイドルプロセッサの電源状態またはプロセッサのスリープ状態に配置できます。 この拡張仮想アイドル状態を使用すると、仮想プロセッサで割り込みがマスクされている場合でも、低電力アイドル状態に配置された仮想プロセッサが割り込みの到着によってウェイクアップされることができます。 つまり、仮想アイドル状態により、ゲストパーティション内のオペレーティングシステムは、ゲストパーティションで実行されている場合には使用できない、OS 内のプロセッサの省電力手法を利用できます。

AccessGuestIdleMsr 特権を持つパーティションは、ハイパーバイザーで定義された MSR に対する読み取りを通じて、仮想プロセッサのアイドル状態のスリープ状態に入ることができ `HV_X64_MSR_GUEST_IDLE` ます。 割り込みが発生したときに仮想プロセッサは、仮想プロセッサで割り込みが有効になっているかどうかに関係なく、ウェイクアップされます。

## <a name="virtual-processor-assist-page"></a>仮想プロセッサのサポートページ

ハイパーバイザーは、ゲストの GPA 領域にオーバーレイされる仮想プロセッサごとにページを提供します。 このページは、ゲスト副社長とハイパーバイザー間の双方向通信に使用できます。 ゲスト OS には、この仮想 VP サポートページへの読み取り/書き込みアクセス権があります。

ゲストは、仮想 VP アシスト MSR (0x40000073) に書き込むことによって、オーバーレイページ (GPA space 内) の場所を指定します。 仮想 VP アシストページ MSR の形式は次のとおりです。

| Bits      | フィールド           | 説明                                                                 |
|-----------|-----------------|-----------------------------------------------------------------------------|
| 0         | 有効化          | VP サポートページを有効にします                                                  |
| 11:1      | RsvdP           | 予約済み                                                                    |
| 63:12     | ページ PFN        | Virtual VP のサポートページ PFN                                                  |

## <a name="virtual-processor-run-time-register"></a>仮想プロセッサの実行時登録

ハイパーバイザーのスケジューラは、実行中のコードで各仮想プロセッサが使用する時間を内部で追跡します。 追跡される時間は、仮想プロセッサが実行されているゲストコードを使用した時間と、関連付けられた論理プロセッサがそのゲストに代わってハイパーバイザーコードを実行する時間を組み合わせたものです。 この累積時間は、64ビットの読み取り専用 HV_X64_MSR_VP_RUNTIME ハイパーバイザー MSR を介してアクセスできます。 時間の数量は、100ナノ秒単位で測定されます。

## <a name="non-privileged-instruction-execution-prevention-npiep"></a>特権のない命令実行防止 (NPIEP)

権限のない命令の実行 (NPIEP) は、ユーザーモードコードによって特定の命令の使用を制限する機能です。 具体的には、この機能を有効にすると、SIDT、SGDT、SLDT、および STR 命令の実行がブロックされることがあります。 これらの命令を実行すると #GP エラーになります。

この機能は、 [HV_X64_MSR_NPIEP_CONFIG_CONTENTS](datatypes/HV_X64_MSR_NPIEP_CONFIG_CONTENTS.md)を使用して、VP 単位で構成する必要があります。

## <a name="guest-spinlocks"></a>ゲストスピンロック

一般的なマルチプロセッサ対応のオペレーティングシステムでは、特定の操作の原子性を適用するためにロックが使用されます。 ハイパーバイザーによって制御される仮想マシン内でこのようなオペレーティングシステムを実行する場合、ロックによって保護されるこれらの重要なセクションは、クリティカルセクションコードによって生成されるインターセプトによって拡張できます。 クリティカルセクションのコードは、ハイパーバイザースケジューラによって割り込まれることもあります。 ハイパーバイザーはこのような preemptions を防止しようとしますが、発生する可能性があります。 その結果、ロックの所有者が再スケジュールされるまで、他のロック contenders がスピンアップして、スピンロックの取得時間が大幅に延長される可能性があります。

ハイパーバイザーは、ハイパーバイザーへの過度なスピン状態を示す前にスピンロック取得を試行する回数をゲスト OS に示します。 この数は、CPUID リーフ0x40000004 で返されます。

[HvCallNotifyLongSpinWait](hypercalls/HvCallNotifyLongSpinWait.md)ハイパーコールは、マルチプロセッサ仮想マシンのロックの統計的な公平性プロパティを向上させるために対応ゲスト向けのインターフェイスを提供します。 ゲストは、CPUID リーフ0x40000004 によって返される推奨される数の倍数で、この通知を行う必要があります。 このハイパーコールにより、ゲストは長時間のスピンロックの取得をハイパーバイザーに通知します。 これにより、ハイパーバイザーはスケジュールの決定をより適切に行うことができます。