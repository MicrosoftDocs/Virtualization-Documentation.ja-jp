---
title: タイマー
description: ハイパーバイザータイマー
keywords: hyper-v
author: alexgrest
ms.author: alegre
ms.date: 10/15/2020
ms.topic: reference
ms.prod: windows-10-hyperv
ms.openlocfilehash: acd5139517194db4f790f27e8b5cf12b3eac1749
ms.sourcegitcommit: d43632e3dc22e2b7a256b5c15fbb665c047de286
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/16/2020
ms.locfileid: "92121225"
---
# <a name="timers"></a>タイマー

ハイパーバイザーは、単純なタイミングサービスを提供します。 これらは、定数レート参照タイムソース (通常は x64 システムの ACPI タイマー) に基づいています。

次のタイマーサービスが提供されています。

- パーティションごとの参照時間カウンター。
- 仮想プロセッサごとに4つの統合タイマー。 各合成タイマーは、メッセージを配信したり、期限切れになったときに割り込みをアサートしたりする単一ショットまたは定期的なタイマーです。
- 仮想プロセッサごとに1つの仮想 APIC タイマー。
- ホストプラットフォームでのインバリアントタイムスタンプカウンター (iTSC) のサポートに基づいたパーティション参照時間。

## <a name="reference-counter"></a>参照カウンター

ハイパーバイザーは、パーティションごとの参照時刻カウンターを保持します。 これには、パーティションのすべての仮想プロセッサに見られるように、連続的に増加する (時間) 値を返すという特性があります。 さらに、参照カウンターはレート定数であり、プロセッサまたはバス速度遷移または詳細プロセッサの省電力の状態によって影響を受けません。 パーティションが作成されると、パーティションの参照時刻カウンターは0に初期化されます。 すべてのパーティションの参照カウンターは同じ速度でカウントされますが、常に、パーティションの作成時間が異なるため、これらの絶対値は通常異なります。

参照カウンターは、少なくとも1つの仮想プロセッサが明示的に中断されていない限り、カウントを継続します。

### <a name="partition-reference-counter-msr"></a>パーティション参照カウンター MSR

パーティションの参照カウンターには、パーティション全体の MSR を使用してアクセスできます。

| MSR アドレス      | レジスタ名              | 説明                                                                 |
|------------------|----------------------------|-----------------------------------------------------------------------------|
| 0x40000020       | HV_X64_MSR_TIME_REF_COUNT  | 時間参照カウント (パーティション全体)                                       |

パーティションが作成されると、TIME_REF_COUNT MSR の値が0x0000000000000000 に設定されます。 この値は、仮想プロセッサでは変更できません。 書き込みを試行すると、#GP エラーになります。

### <a name="partition-reference-time-enlightenment"></a>パーティション参照時間の啓蒙

パーティション参照時間の啓蒙は、ハイパーバイザーへのインターセプトを必要としないパーティションに参照タイムソースを提示します。 この啓蒙は、基になるプラットフォームがインバリアントプロセッサタイムスタンプカウンター (TSC) または iTSC をサポートしている場合にのみ使用できます。 このようなプラットフォームでは、プロセッサのクロック周波数の変化 (ACPI プロセッサのパフォーマンス状態、プロセッサのアイドル状態のスリープ状態 (ACPI C-states) など) が使用されているため、プロセッサのクロック周波数の変化にかかわらず、プロセッサの TSC 頻度は一定のままです。

パーティション参照時の啓蒙では、仮想 TSC 値、オフセット、および乗数を使用して、パーティションの作成以降に正規化された参照時間を計算するためにゲストパーティションを有効にします (100 ナノ秒単位)。 また、ゲストパーティションは、ゲストパーティションが異なる TSC レートでプラットフォームに移行された場合に、その参照時刻をアトミックに計算することもできます。また、コンスタントレート TSC 機能を使用しないプラットフォームへの移行をサポートするフォールバックメカニズムを提供します。

この機能は、この機能を使用して計算された参照時間は、その後の復元が行われるまで、ゲストパーティションが保存されている間は停止しているように見えるため、この機能は、ウォールクロックの時間のソースとして使用するためのものではありません。

#### <a name="partition-reference-time-stamp-counter-page"></a>[パーティション参照タイムスタンプカウンター] ページ

ハイパーバイザーには、パーティションの GPA 領域に関連する、パーティション全体の仮想参照 TSC ページが用意されています。 パーティションの参照タイムスタンプカウンターページにアクセスするには、Reference TSC MSR を使用します。

Reference TSC ページは、次の構造を使用して定義されます。

 ```c
typedef struct
{
    volatile UINT32 TscSequence;
    UINT32 Reserved1;
    volatile UINT64 TscScale;
    volatile INT64 TscOffset;
    UINT64 Reserved2[509];
} HV_REFERENCE_TSC_PAGE;
 ```

#### <a name="reference-time-stamp-counter-tsc-page-msr"></a>参照タイムスタンプカウンター (TSC) ページ MSR

参照 TSC ページにアクセスするゲストは、次のモデル固有レジスタ (MSR) を使用する必要があります。 AccessPartitionReferenceTsc 特権を持つパーティションは、MSR にアクセスできます。

| MSR アドレス      | レジスタ名              | 説明                                                                 |
|------------------|----------------------------|-----------------------------------------------------------------------------|
| 0x40000021       | HV_X64_MSR_REFERENCE_TSC   | [Reference TSC] ページ                                                          |

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:12         | GPA ページ番号                     | 読み取り/書き込み                                                |
| 11:1          | RsvdP (値を保持する必要があります)   | 読み取り/書き込み                                                |
| 0             | 有効化                              | 読み取り/書き込み                                                |

ゲストパーティションの作成時に、参照 TSC MSR の値は0x0000000000000000 になります。 このため、[参照 TSC] ページは既定で無効になっています。 ゲストは、ビット0を設定して reference TSC ページを有効にする必要があります。 指定されたベースアドレスがパーティションの GPA 空間の末尾を超えている場合、参照 TSC ページにはゲストがアクセスできません。 登録を変更するとき、ゲストは予約済みのビットの値 (1 ~ 11) を保持して、将来の互換性を維持する必要があります。

#### <a name="partition-reference-tsc-mechanism"></a>パーティション参照 TSC メカニズム

パーティション参照時間は、次の式によって計算されます。

ReferenceTime = ((VirtualTsc * TscScale)  >> 64) + TscOffset

乗算は64ビット乗算で、128ビット数値になります。これにより、64倍の時間が、高い64ビットを取得するために右にシフトされます。

TscScale 値は、移行イベント間で仮想 TSC の値を調整して、あるプラットフォームから別のプラットフォームへの TSC 頻度の変化を軽減するために使用されます。

TscSequence 値は、保存/復元またはライブマイグレーション中にスケールまたはオフセットフィールドが変更された場合に、対応参照時刻へのアクセスを同期するために使用されます。 このフィールドは、スケールやオフセットフィールドが変更されるたびにインクリメントされるシーケンス番号として機能します。 特別な値0x0 は、この機能が参照時の信頼性の高いソースではなくなり、VM が別のソースに戻される必要があることを示すために使用されます。

この啓蒙を使用してパーティション参照時間を計算するために推奨されるコードを次に示します。

```c
do
{
    StartSequence = ReferenceTscPage->TscSequence;
    if (StartSequence == 0)
    {
        // 0 means that the Reference TSC enlightenment is not available at
        // the moment, and the Reference Time can only be obtained from
        // reading the Reference Counter MSR.
        ReferenceTime = rdmsr(HV_X64_MSR_TIME_REF_COUNT);
        return ReferenceTime;
    }

    Tsc = rdtsc();

    // Assigning Scale and Offset should neither happen before
    // setting StartSequence, nor after setting EndSequence.
    Scale = ReferenceTscPage->TscScale;
    Offset = ReferenceTscPage->TscOffset;

    EndSequence = ReferenceTscPage->TscSequence;
} while (EndSequence != StartSequence);

// The result of the multiplication is treated as a 128-bit value.
ReferenceTime = ((Tsc * Scale) >> 64) + Offset;
return ReferenceTime;
```

## <a name="synthetic-timers"></a>合成タイマー

合成タイマーは、指定された時間の経過後に割り込みを生成するためのメカニズムを提供します。 ワンショットと定期的なタイマーの両方がサポートされています。 合成タイマーは、指定された SynIC SINTx (合成割り込みソース) に有効期限が切れたときにメッセージを送信するか、構成方法に応じて割り込みをアサートします。

ハイパーバイザーは、有効期限が切れる前にタイマーの有効期限シグナルが配信されないことを保証します。 シグナルは、有効期限が切れるといつでも到着する可能性があります。

### <a name="periodic-timers"></a>周期的タイマー

ハイパーバイザーは定期的に定期的にタイマーを通知しようとします。 ただし、有効期限を示すために使用された仮想プロセッサが使用できない場合は、タイマーの有効期限の一部が遅れている可能性があります。 仮想プロセッサが中断されている (たとえば、インターセプト処理中など) か、またはハイパーバイザーのスケジューラによって仮想プロセッサが論理プロセッサにスケジュールされていないと判断された (たとえば、別の仮想プロセッサが論理プロセッサを使用しているか、仮想プロセッサがクォータを超過している) ことが考えられます。

長時間にわたって仮想プロセッサを使用できない場合は、完全なタイマー期間が失われる可能性があります。 この場合、ハイパーバイザーは2つの方法のいずれかを使用します。

最初の手法では、タイマー期間変調が適用され、タイマーが "キャッチアップ" するまで期間が短縮されます。 多数のタイマー信号が欠落している場合、ハイパーバイザーは、期間変調を使用して補正できない可能性があります。 この場合、一部のタイマーの有効期限のシグナルが完全にスキップされる可能性があります。

遅延としてマークされているタイマーの場合、ハイパーバイザーは、仮想プロセッサを長時間使用できない状況に対処するために2番目の手法を使用します。 この場合、この仮想プロセッサが使用可能になるまでタイマー信号は遅延されます。 次のタイマーの有効期限が切れるまですぐに使用できなくなると、完全にはスキップされます。

### <a name="ordering-of-timer-expirations"></a>タイマーの有効期限の順序

合成および仮想化されたタイマーは、指定された有効期限に達した時点またはそれに近い時間に割り込みを生成 ハードウェアおよびその他のスケジューリング操作により、割り込みが遅延する可能性があります。 タイマーのセット間で順序付けを想定することはできません。

### <a name="direct-synthetic-timers"></a>ダイレクト代理タイマー

"Direct" 合成タイマーは、SynIc 合成割り込みソースにメッセージを送信するのではなく、タイマーの有効期限時に割り込みをアサートします。 統合タイマー構成 MSRs の "DirectMode" フィールドを設定することによって、合成タイマーが "direct" モードに設定されます。 "ApicVector" フィールドは、タイマーの有効期限時にアサートされる割り込みベクターを制御します。

### <a name="synthetic-timer-msrs"></a>統合タイマー MSRs

合成タイマーは、各仮想プロセッサに関連付けられたモデル固有のレジスタ (MSRs) を使用して構成されます。 4つの各合成タイマーには、MSRs のペアが関連付けられています。

| MSR アドレス      | レジスタ名                   | 説明                                                    |
|------------------|---------------------------------|----------------------------------------------------------------|
| 0x400000B0       | HV_X64_MSR_STIMER0_CONFIG       | 合成タイマー0の構成レジスタです。                  |
| 0x400000B1       | HV_X64_MSR_STIMER0_COUNT        | 合成タイマー0の有効期限または期間。               |
| 0x400000B2       | HV_X64_MSR_STIMER1_CONFIG       | 合成タイマー1の構成レジスタ。                  |
| 0x400000B3       | HV_X64_MSR_STIMER1_COUNT        | 統合タイマー1の有効期限または期間。               |
| 0x400000B4       | HV_X64_MSR_STIMER2_CONFIG       | 合成タイマー2の構成レジスタ。                  |
| 0x400000B5       | HV_X64_MSR_STIMER2_COUNT        | 統合タイマー2の有効期限または期間。               |
| 0x400000B6       | HV_X64_MSR_STIMER3_CONFIG       | 合成タイマー3の構成レジスタ。                  |
| 0x400000B7       | HV_X64_MSR_STIMER4_COUNT        | 統合タイマー3の有効期限または期間。               |

#### <a name="synthetic-timer-configuration-register"></a>統合タイマー構成登録

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:20         | RsvdZ (値は0に設定する必要があります) | 読み取り/書き込み                                                |
| 19:16         | SINTx 合成割り込みソース  | 読み取り/書き込み                                                |
| 15:13         | RsvdZ (値は0に設定する必要があります) | 読み取り/書き込み                                                |
| 12            | ダイレクトモード-タイマーの有効期限時のアサートと割り込み。 | 読み取り/書き込み                          |
| 11:4          | ApicVector-直接モードでアサートされた割り込みベクターを制御します。 | 読み取り/書き込み                 |
| 3             | AutoEnable-対応するカウンターを書き込むとタイマーが暗黙的に有効になる場合に設定します。 | 読み取り/書き込み |
| 2             | 遅延-タイマーが遅延の場合に設定          | 読み取り/書き込み                                               |
| 1             | 周期タイマーが定期的に設定されている場合  | 読み取り/書き込み                                               |
| 0             | Enabled-タイマーが有効な場合に設定されます    | 読み取り/書き込み                                               |

仮想プロセッサを作成してリセットすると、すべての HV_X64_MSR_STIMERx_CONFIG (合成タイマー構成) レジスタの値が0x0000000000000000 に設定されます。 したがって、すべての合成タイマーは既定で無効になっています。

AutoEnable が設定されている場合、対応するカウントレジスタに0以外の値を書き込むと、Enable が設定され、カウンターがアクティブになります。 それ以外の場合は、対応する count レジスタを書き込んだ後で Enable を設定して、カウンターをアクティブにします。 Count レジスタの詳細については、次のセクションを参照してください。

ワンショットタイマーが期限切れになると、自動的に無効としてマークされます。 周期的なタイマーは、明示的に無効にするまで有効のままです。

ワンショットが有効になっていて、指定した数が過去の場合は、すぐに期限切れになります。

有効なタイマー (direct モードではない) では、SINTx フィールドを0に設定することはできません。 試行した場合、タイマーはすぐに無効 (ビット0クリア) としてマークされます。

既に有効になっているタイマーの構成レジスタを書き込むと、未定義の動作が発生する可能性があります。 たとえば、タイマーをワンショットから周期的に変更するだけでは、意図したものが生成されない場合があります。 他のプロパティを変更する前に、タイマーを常に無効にする必要があります。

#### <a name="synthetic-timer-count-register"></a>合成タイマーカウントレジスタ

| Bits          | 説明                                                             | 属性              |
|---------------|-------------------------------------------------------------------------|-------------------------|
| 63:0          | カウント—ワンショットタイマーの有効期限、定期的なタイマーの期間 | 読み取り/書き込み            |

Count レジスタにプログラミングされた値は、100ナノ秒単位で計測された時間値です。 値0をカウントレジスタに書き込むと、カウンターが停止し、構成レジスタの AutoEnable の設定とは無関係にタイマーが無効になります。

Count レジスタをラップできることに注意してください。 ラップは、タイマープロパティに関係なく、タイマーの動作には影響しません。

ワンショットタイマーでは、タイマーの絶対有効期限を表します。 タイマーは、パーティションの参照カウンターが指定されたカウント値以上になると有効期限が切れます。

周期的なタイマーの場合、カウントはタイマーの期間を表します。 最初の期間は、合成タイマーが有効になった時点で開始されます。

### <a name="synthetic-timer-expiration-message"></a>合成タイマーの有効期限メッセージ

タイマーの有効期限メッセージは、タイマーイベントが発生したときに送信されます。 メッセージペイロードの定義については、 [HV_TIMER_MESSAGE_PAYLOAD](datatypes/HV_TIMER_MESSAGE_PAYLOAD.md) を参照してください。

### <a name="synthetic-time-unhalted-timer-msrs"></a>統合 Time-Unhalted タイマー MSRs

統合 Time-Unhalted タイマー MSRs は、パーティションに AccessSyntheticTimerRegs 特権があり、ハイパーバイザー機能 Id CPUID リーフ0x40000003 が設定されている場合に使用できます。 ゲストソフトウェアは、100ナノ秒単位で指定された時間に実行した後に定期的な割り込みを生成するように、合成時間の停止タイマーをプログラムする場合があります。 割り込みが発生すると、VP アシストページの SyntheticTimeUnhaltedTimerExpired フィールドが TRUE に設定されます。 ゲストソフトウェアによって、このフィールドが FALSE にリセットされる場合があります。 アーキテクチャパフォーマンスカウンターとは異なり、合成タイマーはハイパーバイザーによってリセットされることはなく、割り込み間で継続的に実行されます。 ベクター = = 2: NMI を送信し、他のベクターは固定割り込みを送信します。

ゲストが停止した時間を累積する通常の代理タイマー (つまり、アイドル状態になった) とは異なり、合成 Time-Unhalted タイマーは、ゲストが停止していない間のみ時間を累積します。

| MSR アドレス      | レジスタ名                          | 説明                                             |
|------------------|----------------------------------------|---------------------------------------------------------|
| 0x40000114       | HV_X64_MSR_STIME_UNHALTED_TIMER_CONFIG | 統合 Time-Unhalted タイマー構成 MSR         |
| 0x40000115       | HV_X64_MSR_STIME_UNHALTED_TIMER_COUNT  | 統合 Time-Unhalted タイマーカウント MSR                 |

#### <a name="synthetic-time-unhalted-timer-configuration-msr"></a>統合 Time-Unhalted タイマー構成 MSR

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:9          | RsvdZ (値は0に設定する必要があります) | 読み取り/書き込み                                                |
| 8             | Enabled                             | 読み取り/書き込み                                                |
| 7:0           | ベクター                              | 読み取り/書き込み                                                |

#### <a name="synthetic-time-unhalted-timer-count-msr"></a>統合 Time-Unhalted タイマーカウント MSR

| Bits          | 説明                                                             | 属性              |
|---------------|-------------------------------------------------------------------------|-------------------------|
| 63:0          | 100 ns ユニットの割り込みの頻度                             | 読み取り/書き込み            |