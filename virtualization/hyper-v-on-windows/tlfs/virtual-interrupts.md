---
title: 仮想割り込みコントローラー
description: ハイパーバイザー仮想割り込みコントローラーインターフェイス
keywords: hyper-v
author: alexgrest
ms.author: alegre
ms.date: 10/15/2020
ms.topic: reference
ms.prod: windows-10-hyperv
ms.openlocfilehash: 4311ac0698bfda86c4a840c2cc7052828f808e59
ms.sourcegitcommit: d43632e3dc22e2b7a256b5c15fbb665c047de286
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 10/16/2020
ms.locfileid: "92120834"
---
# <a name="virtual-interrupt-controller"></a>仮想割り込みコントローラー

ハイパーバイザーは、仮想プロセッサへの割り込み配信を仮想化します。 これを行うには、仮想化されたローカル APIC の拡張である合成割り込みコントローラー (SynIC) を使用します。つまり、各仮想プロセッサには、SynIC 拡張機能を持つローカルの APIC インスタンスがあります。 これらの拡張機能は、次の章で説明されている単純なパーティション間通信メカニズムを提供します。
パーティションに配信される割り込みは、外部と内部の2つのカテゴリに分類されます。 外部割り込みは他のパーティションまたはデバイスから発生し、内部割り込みはパーティション自体から発生します。

外部割り込みは、次のような場合に生成されます。

- 物理ハードウェアデバイスがハードウェアの割り込みを生成します。
- 親パーティションは、仮想割り込み (通常はハードウェアデバイスをエミュレートするプロセス) をアサートします。
- ハイパーバイザーは、パーティションに対して (たとえば、インターセプトのために) メッセージを配信します。
- 別のパーティションがメッセージを投稿します。
- 別のパーティションがイベントを通知します。

内部割り込みは、次のような場合に生成されます。

- 仮想プロセッサは、APIC 割り込みコマンドレジスタ (ICR) にアクセスします。
- 代理タイマーの有効期限が切れます。

## <a name="local-apic"></a>ローカル APIC

SynIC は、ローカル APIC のスーパーセットです。 この APIC へのインターフェイスは、32ビットメモリマップレジスタのセットによって指定されます。 このローカル APIC (メモリマップレジスタの動作を含む) は、Intel のおよび AMD のドキュメントで説明されているように、一般的に P4/Xeon システムのローカル APIC と互換性があります。

ハイパーバイザーのローカル APIC 仮想化は、次のわずかな方法で、物理的な APIC 操作から逸脱する可能性があります。

- 物理システムでは、システム内のプロセッサごとに IA32_APIC_BASE MSR が異なる場合があります。 ハイパーバイザーでは、この MSR にパーティション内のすべての仮想プロセッサに対して同じ値が含まれていることが必要になる場合があります。 そのため、この MSR は、パーティション全体の値として扱うことができます。 仮想プロセッサによってこのレジスタが変更された場合、その値は、パーティション内のすべての仮想プロセッサに効果的に反映される可能性があります。
- IA32_APIC_BASE MSR は、APIC を有効または無効にする "グローバル有効化" ビットを定義します。 仮想化された APIC は常に有効になっている可能性があります。 その場合、このビットは常に1に設定されます。
- ハイパーバイザーのローカル APIC が仮想 SMIs (システム管理の割り込み) を生成できない可能性があります。
- パーティション内の複数の仮想プロセッサに同一の APIC Id が割り当てられている場合、対象となる割り込み配信の動作は boundedly undefined になります。 つまり、ハイパーバイザーは、1つの仮想プロセッサ、指定された APIC ID を持つすべての仮想プロセッサ、または仮想プロセッサなしに、割り込みを無料で配信できます。 この状況は、ゲストプログラミングエラーと見なされます。
- メモリマップされた APIC レジスタの一部は、仮想 MSRs を使用してアクセスできます。
- ハイパーバイザーでは、ゲストがその APIC Id を変更することを許可していない可能性があります。

このセクションの残りの部分では、ローカル APIC の拡張機能である SynIC 機能の側面についてのみ説明します。

### <a name="local-apic-msr-accesses"></a>ローカルの APIC MSR アクセス

ハイパーバイザーは、高使用メモリマップされた APIC レジスタへの高速 MSR アクセスを提供します。 これらは、TPR、EOI、および ICR レジスタです。 ICR low レジスタと ICR high レジスタが1つの MSR に結合されます。 パフォーマンス上の理由から、ゲストオペレーティングシステムは、APIC MSRs の使用に関するハイパーバイザーの推奨事項に従う必要があります。

| MSR アドレス      | レジスタ名       | 説明                                                                 |
|------------------|---------------------|-----------------------------------------------------------------------------|
| 0x40000070       | HV_X64_MSR_EOI      | APIC EOI にアクセスします。                                                       |
| 0x40000071       | HV_X64_MSR_ICR      | APIC ICR-high と ICR にアクセスします                                      |
| 0x40000072       | HV_X64_MSR_TPR      | APIC TPR にアクセスする                                                         |

#### <a name="hv_x64_msr_eoi"></a>HV_X64_MSR_EOI

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:32         | RsvdZ (予約済み、ゼロである必要があります)    | Write                                                       |
| 31:0          | EOI 値                           | Write                                                       |

#### <a name="hv_x64_msr_icr"></a>HV_X64_MSR_ICR

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:32         | ICR high 値                      | 読み取り/書き込み                                                |
| 31:0          | ICR low 値                       | 読み取り/書き込み                                                |

#### <a name="hv_x64_msr_tpr"></a>HV_X64_MSR_TPR

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 63:8          | RsvdZ (予約済み、ゼロである必要があります)    | 読み取り/書き込み                                                |
| 7:0           | TPR 値                           | 読み取り/書き込み                                                |

この MSR は、32ビットモードのゲストパーティションで TPR へのアクセスを高速化することを目的としています。 64-ビットモードのゲストパーティションでは、CR8 を使って TPR を設定する必要があります。

### <a name="synthetic-cluster-ipi"></a>統合クラスター IPI

ハイパーバイザーでは、が仮想固定割り込みを任意の仮想プロセッサのセットに送信できるハイパーコールがサポートされています。

| ハイパーコール                                                                           | 説明                                     |
|-------------------------------------------------------------------------------------|-------------------------------------------------|
| [Hvcallsendsyntheの Clusteripi](hypercalls/HvCallSendSyntheticClusterIpi.md)      | 指定された仮想プロセッサセットに仮想固定割り込みを送信します。 |
| [HvCallSendSyntheticClusterIpiEx](hypercalls/HvCallSendSyntheticClusterIpiEx.md)  | Hvcallsendsyntheの Clusteripi と同様に、はスパース VP を入力として受け取ります。    |

### <a name="eoi-assist"></a>EOI Assist

[ [仮想プロセッサのサポート] ページ](vp-properties.md#virtual-processor-assist-page) の1つのフィールドは Eoi assist フィールドです。 EOI Assist フィールドは、オーバーレイページのオフセット0にあり、サイズは32ビットです。 EOI assist フィールドの形式は次のとおりです。

| Bits          | 説明                         | 属性                                                  |
|---------------|-------------------------------------|-------------------------------------------------------------|
| 31:1          | RsvdZ                               | 読み取り/書き込み                                                |
| 0             | EOI は不要です                     | 読み取り/書き込み                                                |

ゲスト OS は、virtual VP アシストページの EOI Assist フィールドにゼロをアトミックに書き込んで EOI を実行し、"No EOI required" フィールドが以前は0であるかどうかを確認します。 存在する場合、OS は HV_X64_APIC_EOI MSR に書き込む必要があり、その結果、ハイパーバイザーへのインターセプトがトリガーされます。 EOI を実行するには、次のコードをお勧めします。

```
lea rcx, [VirtualApicAssistVa]
btr [rcx], 0
jc NoEoiRequired

mov ecx, HV_X64_APIC_EOI
wrmsr

NoEoiRequired:
```

ハイパーバイザーは、次の条件が満たされた場合に仮想割り込みを挿入するときに、"No EOI required" ビットを設定します。

- 仮想割り込みはエッジによってトリガーされ、
- 優先度の低い割り込みは保留されていません

後で優先度の低い割り込みが要求された場合、ハイパーバイザーは "No EOI required" をクリアします。これにより、後続の EOI がインターセプトを発生させます。

割り込みが入れ子になっている場合は、最も優先度の高い割り込みに対してのみ EOI インターセプトが回避されます。 これは、OS によって実行される EOIs の数に対してカウントが保持されないために必要です。 そのため、最初の EOI だけを避けることができ、最初の EOI は "No EOI Required" ビットをクリアするため、次の EOI はインターセプトを生成します。 ただし、入れ子になった割り込みはめったに発生しないので、これは一般的なケースでは問題になりません。

デバイスや i/o APIC (物理または合成) には、エッジによってトリガーされる割り込みの EOI が通知されないことに注意してください。ハイパーバイザーは、仮想 APIC 状態を更新するためだけに EOIs をインターセプトします。 場合によっては、仮想 APIC の状態が遅延更新されることがあります。このような場合、"NoEoiRequired" ビットがハイパーバイザーによって設定され、EOI のインターセプトが不要であることがゲストに示されます。 後で、ハイパーバイザーは、"NoEoiRequired" ビットの現在の値に応じて、ローカルの APIC の状態を取得できます。

この啓蒙を有効または無効にすることは、割り込みアクティビティとその時点での APIC 状態に関係なくいつでも行うことができます。 啓蒙が有効になっている間でも、従来の EOIs は "No EOI required" 値に関係なく実行できますが、啓蒙のパフォーマンス上の利点を実感することはできません。
